# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# æ—¥å ±ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReact+Vite+TypeScriptï¼‰ã®CI
name: Frontend CI

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å®šç¾©
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  push:
    branches: [ main ]
    # frontendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  
  # Pull RequestãŒmainãƒ–ãƒ©ãƒ³ãƒã«ä½œæˆã•ã‚ŒãŸæ™‚ï¼ˆãƒãƒ¼ã‚¸å‰ã®ãƒã‚§ãƒƒã‚¯ï¼‰
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆå…¨ã‚¸ãƒ§ãƒ–ã§å…±é€šï¼‰
env:
  NODE_VERSION: '18'  # Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
  WORKING_DIR: 'frontend'  # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

# å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  # CIã‚¸ãƒ§ãƒ–ï¼ˆé™çš„è§£æï¼‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
  ci:
    # å®Ÿè¡Œç’°å¢ƒï¼ˆUbuntuæœ€æ–°ç‰ˆã‚’ä½¿ç”¨ï¼‰
    runs-on: ubuntu-latest
    
    # ã‚¸ãƒ§ãƒ–å†…ã§å®Ÿè¡Œã™ã‚‹å‡¦ç†ã®ã‚¹ãƒ†ãƒƒãƒ—
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆå–å¾—ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # 2. Node.jsã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # package-lock.jsonã‚’ä½¿ã£ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ï¼‰
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'
      
      # 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci  # package-lock.jsonã«åŸºã¥ãé«˜é€Ÿã§ç¢ºå®Ÿãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      
      # 4. é™çš„è§£æï¼ˆLintï¼‰ã®å®Ÿè¡Œ
      - name: Run ESLint
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ” é™çš„è§£æï¼ˆESLintï¼‰ã‚’å®Ÿè¡Œä¸­..."
          npm run lint 2>&1 | tee eslint-results.log
          # teeã‚³ãƒãƒ³ãƒ‰ã§çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¤ã¤æ¨™æº–å‡ºåŠ›ã«ã‚‚è¡¨ç¤º
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¸ãƒ§ãƒ–ã‚’ç¶šè¡Œï¼ˆãƒ†ã‚¹ãƒˆã‚‚å®Ÿè¡Œã™ã‚‹ãŸã‚ï¼‰
        continue-on-error: true
        id: eslint
      
      # 5. å‹ãƒã‚§ãƒƒã‚¯ï¼ˆTypeScriptï¼‰ã®å®Ÿè¡Œ
      - name: Run TypeScript type check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“ TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          npm run type-check 2>&1 | tee typecheck-results.log
          # type-checkã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç„¡ã„å ´åˆã¯ç›´æ¥tscã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
          # npx tsc --noEmit 2>&1 | tee typecheck-results.log
        continue-on-error: true
        id: typecheck
      
      # 6. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      - name: Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          npm run test 2>&1 | tee test-results.log
        continue-on-error: true
        id: test
      
      # 7. ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œï¼ˆæœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèªï¼‰
      - name: Build project
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          npm run build 2>&1 | tee build-results.log
        continue-on-error: true
        id: build
      
      # 8. çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰
      - name: Upload results as artifacts
        uses: actions/upload-artifact@v4
        if: always()  # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå¸¸ã«å®Ÿè¡Œ
        with:
          name: ci-results-${{ github.run_number }}
          path: |
            ${{ env.WORKING_DIR }}/eslint-results.log
            ${{ env.WORKING_DIR }}/typecheck-results.log
            ${{ env.WORKING_DIR }}/test-results.log
            ${{ env.WORKING_DIR }}/build-results.log
          retention-days: 30  # 30æ—¥é–“ä¿æŒ
      
      # 9. çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤º
      - name: Create result summary
        if: always()
        run: |
          echo "## ğŸ“Š CIå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¹ãƒ†ãƒƒãƒ— | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          # ESLintã®çµæœ
          if [ "${{ steps.eslint.outcome }}" == "success" ]; then
            echo "| ESLint | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ESLint | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã®çµæœ
          if [ "${{ steps.typecheck.outcome }}" == "success" ]; then
            echo "| TypeScriptå‹ãƒã‚§ãƒƒã‚¯ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| TypeScriptå‹ãƒã‚§ãƒƒã‚¯ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ãƒ†ã‚¹ãƒˆã®çµæœ
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "| ãƒ†ã‚¹ãƒˆ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ãƒ†ã‚¹ãƒˆ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ãƒ“ãƒ«ãƒ‰ã®çµæœ
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "| ãƒ“ãƒ«ãƒ‰ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ãƒ“ãƒ«ãƒ‰ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªãƒ­ã‚°ã¯ã€ŒArtifactsã€ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
      
      # 10. æœ€çµ‚åˆ¤å®šï¼ˆã„ãšã‚Œã‹ãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã‚’å¤±æ•—ã«ã™ã‚‹ï¼‰
      - name: Final result check
        if: always()
        run: |
          if [ "${{ steps.eslint.outcome }}" != "success" ] || \
             [ "${{ steps.typecheck.outcome }}" != "success" ] || \
             [ "${{ steps.test.outcome }}" != "success" ] || \
             [ "${{ steps.build.outcome }}" != "success" ]; then
            echo "âŒ ã„ãšã‚Œã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          else
            echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
          fi
