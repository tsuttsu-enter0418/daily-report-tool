# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# æ—¥å ±ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReact+Vite+TypeScriptï¼‰ã®CI/CD
name: Frontend CI/CD

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-ci.yml"

  pull_request:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-ci.yml"

jobs:
  # CIã‚¸ãƒ§ãƒ–ï¼ˆé™çš„è§£æžï¼‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰- PRã¨mainãƒ–ãƒ©ãƒ³ãƒä¸¡æ–¹ã§å®Ÿè¡Œ
  ci:
    name: ci-job
    runs-on: ubuntu-latest
    # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†å‡ºåŠ›ã‚’å®šç¾©
    outputs:
      ci_success: ${{ steps.ci-results.outputs.ci_success }}
    env:
      NODE_VERSION: "20"
      WORKING_DIR: "frontend"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ env.WORKING_DIR }}/package-lock.json"

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          npm ci

      - name: Run ESLint
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ” é™çš„è§£æžï¼ˆESLintï¼‰ã‚’å®Ÿè¡Œä¸­..."
          npm run lint 2>&1 | tee eslint-results.log
        continue-on-error: true
        id: eslint

      - name: Run TypeScript type check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“ TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          npx tsc --noEmit 2>&1 | tee typecheck-results.log
        continue-on-error: true
        id: typecheck

      - name: Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          npm run test 2>&1 | tee test-results.log
        continue-on-error: true
        id: test

      - name: Build project
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          npm run build 2>&1 | tee build-results.log
        continue-on-error: true
        id: build

      - name: Upload results as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-results-${{ github.run_number }}
          path: |
            ${{ env.WORKING_DIR }}/eslint-results.log
            ${{ env.WORKING_DIR }}/typecheck-results.log
            ${{ env.WORKING_DIR }}/test-results.log
            ${{ env.WORKING_DIR }}/build-results.log
          retention-days: 30

      - name: Create result summary
        if: always()
        run: |
          echo "## ðŸ“Š CIå®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¹ãƒ†ãƒƒãƒ— | çµæžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.eslint.outcome }}" == "success" ]; then
            echo "| ESLint | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ESLint | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.typecheck.outcome }}" == "success" ]; then
            echo "| TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "| ãƒ†ã‚¹ãƒˆ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ãƒ†ã‚¹ãƒˆ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "| ãƒ“ãƒ«ãƒ‰ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ãƒ“ãƒ«ãƒ‰ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªãƒ­ã‚°ã¯ã€ŒArtifactsã€ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY

      # CIçµæžœã‚’jobã®å‡ºåŠ›ã¨ã—ã¦è¨­å®šï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ã§å‚ç…§ç”¨ï¼‰
      - name: Set CI results and final check
        id: ci-results
        if: always()
        run: |
          if [ "${{ steps.eslint.outcome }}" == "success" ] && \
             [ "${{ steps.typecheck.outcome }}" == "success" ] && \
             [ "${{ steps.test.outcome }}" == "success" ] && \
             [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "ci_success=true" >> $GITHUB_OUTPUT
            echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
          else
            echo "ci_success=false" >> $GITHUB_OUTPUT
            echo "âŒ ã„ãšã‚Œã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ– - mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã‹ã¤CIãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
  deploy:
    name: deploy-job
    runs-on: ubuntu-latest
    # CIã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
    needs: ci
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã‹ã¤CIãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.ci.outputs.ci_success == 'true'
    env:
      NODE_VERSION: "20"
      WORKING_DIR: "frontend"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ env.WORKING_DIR }}/package-lock.json"

      # AWSèªè¨¼è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # GitHub Secretsã«AWSã®èªè¨¼æƒ…å ±ã‚’è¨­å®š
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1 # æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³

      # AWSèªè¨¼ç¢ºèª
      - name: Verify AWS credentials
        run: |
          echo "ðŸ” AWSèªè¨¼ã‚’ç¢ºèªä¸­..."
          aws sts get-caller-identity
          echo "âœ… AWSèªè¨¼æˆåŠŸ"

      # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å­˜åœ¨ç¢ºèªã¨å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
      - name: Verify and prepare deploy script
        run: |
          if [ ! -f "./scripts/deploy-frontend.sh" ]; then
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ./scripts/deploy-frontend.sh"
            exit 1
          fi
          chmod +x ./scripts/deploy-frontend.sh
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™å®Œäº†"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      - name: Deploy to AWS
        run: |
          echo "ðŸš€ AWSç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹..."
          ./scripts/deploy-frontend.sh
        id: deploy

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          # Slacké€šçŸ¥ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—\nè©³ç´°: GitHub Actions"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼
      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----|" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ | https://kouhei-portfolio.net |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚³ãƒŸãƒƒãƒˆSHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚ | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "| çµæžœ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| çµæžœ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
          fi
