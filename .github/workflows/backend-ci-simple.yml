# Backend CI Pipeline - Simple Version (Phase 1)
name: Backend CI Simple

on:
    pull_request:
        paths:
            - "backend/**"
            - ".github/workflows/backend-ci-simple.yml"
        branches: [main, develop]

env:
    JAVA_VERSION: "17"
    MAVEN_OPTS: "-Xmx3072m"

jobs:
    # ==========================================
    # Job 1: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
    # ==========================================
    test:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_DB: daily_report_tool_test
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK ${{ env.JAVA_VERSION }}
              uses: actions/setup-java@v4
              with:
                  java-version: ${{ env.JAVA_VERSION }}
                  distribution: "temurin"
            # Mavenã®ä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆActionsã®æ©Ÿèƒ½ï¼‰â†’é€Ÿåº¦å‘ä¸Š
            - name: Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  # m2ï¼Mavenã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
                  path: ~/.m2
                  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¸€æ„ã®keyã‚’ä½œæˆã™ã‚‹â†’æ¤œç´¢ã—ã¦ä¸€è‡´ã™ã‚Œã°ãã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã®äºˆé˜²æªç½®
                  restore-keys: ${{ runner.os }}-m2

            - name: Compile and validate
              working-directory: ./backend
              run: |
                  ./mvnw clean compile
                  # pom.xmlã®æ¤œè¨¼
                  ./mvnw validate

            - name: Run Unit Tests
              working-directory: ./backend
              env:
                  SPRING_PROFILES_ACTIVE: test
                  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/daily_report_tool_test
                  SPRING_DATASOURCE_USERNAME: test_user
                  SPRING_DATASOURCE_PASSWORD: test_password
                  SPRING_DATASOURCE_DRIVER: org.postgresql.Driver
                  HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
              run: |
                  ./mvnw test \
                    -Dspring.jpa.hibernate.ddl-auto=create-drop \
                    -Djunit.jupiter.execution.parallel.enabled=true \
                    -Djunit.jupiter.execution.parallel.mode.default=concurrent

            # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãŸã ã—ã€ã¾ã çµ±åˆãƒ†ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‘ã¦ã„ãªã„ã®ã§ä¿ç•™ã—ãŸã„ï¼‰
            - name: Run Integration Tests
              working-directory: ./backend
              env:
                  SPRING_PROFILES_ACTIVE: test
                  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/daily_report_tool_test
                  SPRING_DATASOURCE_USERNAME: test_user
                  SPRING_DATASOURCE_PASSWORD: test_password
                  SPRING_DATASOURCE_DRIVER: org.postgresql.Driver
                  HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
              run: |
                  ./mvnw verify \
                    -Dspring.jpa.hibernate.ddl-auto=create-drop \
                    -Dtest=**/*IntegrationTest

            - name: Generate Test Coverage Report
              working-directory: ./backend
              if: always()
              run: ./mvnw jacoco:report

            - name: Upload Test Results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: |
                      backend/target/surefire-reports/
                      backend/target/failsafe-reports/
                      backend/target/site/jacoco/

            - name: Publish Test Results
              uses: dorny/test-reporter@v1
              if: always()
              with:
                  name: JUnit Test Results
                  path: "backend/target/surefire-reports/*.xml"
                  reporter: java-junit

    # ==========================================
    # Job 2: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    # ==========================================
    code-quality:
        name: Code Quality Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK ${{ env.JAVA_VERSION }}
              uses: actions/setup-java@v4
              with:
                  java-version: ${{ env.JAVA_VERSION }}
                  distribution: "temurin"

            - name: Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Run Checkstyle
              working-directory: ./backend
              run: ./mvnw checkstyle:check

            - name: Upload Checkstyle Results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: checkstyle-results
                  path: backend/target/checkstyle-result.xml

    # ==========================================
    # Job 3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    # ==========================================
    security-scan:
        name: Security Vulnerability Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK ${{ env.JAVA_VERSION }}
              uses: actions/setup-java@v4
              with:
                  java-version: ${{ env.JAVA_VERSION }}
                  distribution: "temurin"

            - name: Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2
            
            # OWASPä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            - name: Cache OWASP NVD Database
              uses: actions/cache@v4
              with:
                  path: ~/.m2/repository/org/owasp/dependency-check-data
                  key: owasp-nvd-${{ github.run_id }}
                  restore-keys: |
                      owasp-nvd-

            - name: Run OWASP Dependency Check
              working-directory: ./backend
              timeout-minutes: 30
              env:
                  # å®Ÿè¡Œæ™‚é–“çŸ­ç¸®ã®ãŸã‚æœ€ä½é™ã®ãƒã‚§ãƒƒã‚¯ã«è¨­å®š
                  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
              run: |
                  # åˆå›å®Ÿè¡Œã¾ãŸã¯APIã‚­ãƒ¼ãªã—ã®å ´åˆã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«10ï¼ˆé«˜è„†å¼±æ€§ã®ã¿ï¼‰
                  ./mvnw org.owasp:dependency-check-maven:check \
                    -DfailBuildOnCVSS=10 \
                    -DskipProvidedScope=true \
                    -DskipRuntimeScope=false \
                    -DskipSystemScope=true || echo "OWASP check completed with warnings"

            - name: Upload OWASP Results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: owasp-dependency-check
                  path: backend/target/dependency-check-report.html

    # ==========================================
    # Job 4: Docker ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
    # ==========================================
    docker-build:
        name: Docker Build Validation
        runs-on: ubuntu-latest
        needs: [test, code-quality]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (validation only)
              working-directory: ./backend
              run: |
                  docker build \
                    --tag daily-report-backend:test \
                    --cache-from type=gha \
                    --cache-to type=gha,mode=max \
                    .

            - name: Test Docker image startup
              run: |
                  # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ãƒ†ã‚¹ãƒˆ
                  docker run --rm -d \
                    --name test-container \
                    -p 8080:8080 \
                    -e SPRING_PROFILES_ACTIVE=test \
                    daily-report-backend:test

                  # èµ·å‹•å¾…æ©Ÿ
                  sleep 30

                  # åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
                  curl -f http://localhost:8080/actuator/health || echo "Health check failed - continuing anyway"

                  # ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
                  docker stop test-container

            - name: Scan Docker image for vulnerabilities
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "daily-report-backend:test"
                  format: "table"
                  exit-code: "0" # è„†å¼±æ€§ãŒã‚ã£ã¦ã‚‚æ­¢ã‚ãªã„ï¼ˆè­¦å‘Šã®ã¿ï¼‰

    # ==========================================
    # Job 5: CIçµæœã‚µãƒãƒªãƒ¼
    # ==========================================
    ci-summary:
        name: CI Results Summary
        runs-on: ubuntu-latest
        needs: [test, code-quality, security-scan, docker-build]
        if: always()

        steps:
            - name: Check all jobs status
              run: |
                  echo "=== CI Results Summary ==="
                  echo "Tests: ${{ needs.test.result }}"
                  echo "Code Quality: ${{ needs.code-quality.result }}"
                  echo "Security Scan: ${{ needs.security-scan.result }}"
                  echo "Docker Build: ${{ needs.docker-build.result }}"

                  # æˆåŠŸåˆ¤å®š
                  if [[ "${{ needs.test.result }}" == "success" ]] && \
                     [[ "${{ needs.code-quality.result }}" == "success" ]] && \
                     [[ "${{ needs.docker-build.result }}" == "success" ]]; then
                    echo "âœ… All critical checks passed"
                  else
                    echo "âŒ Some critical checks failed"
                    exit 1
                  fi

                  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã¯è­¦å‘Šã®ã¿
                  if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
                    echo "âš ï¸ Security scan had issues - please review"
                  fi

            - name: Comment PR (simple)
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const testResult = '${{ needs.test.result }}';
                      const codeQualityResult = '${{ needs.code-quality.result }}';
                      const dockerResult = '${{ needs.docker-build.result }}';
                      const securityResult = '${{ needs.security-scan.result }}';

                      const success = testResult === 'success' &&
                                     codeQualityResult === 'success' &&
                                     dockerResult === 'success';

                      let comment = `## ğŸ” Backend CI Results\n\n`;
                      comment += `| Check | Result |\n`;
                      comment += `|-------|--------|\n`;
                      comment += `| Tests | ${testResult === 'success' ? 'âœ…' : 'âŒ'} ${testResult} |\n`;
                      comment += `| Code Quality | ${codeQualityResult === 'success' ? 'âœ…' : 'âŒ'} ${codeQualityResult} |\n`;
                      comment += `| Docker Build | ${dockerResult === 'success' ? 'âœ…' : 'âŒ'} ${dockerResult} |\n`;
                      comment += `| Security Scan | ${securityResult === 'success' ? 'âœ…' : 'âš ï¸'} ${securityResult} |\n\n`;

                      if (success) {
                        comment += `âœ… **Ready for merge** - All critical checks passed!\n\n`;
                      } else {
                        comment += `âŒ **Needs attention** - Some checks failed.\n\n`;
                      }

                      comment += `ğŸ“Š [View detailed results](${context.payload.pull_request.html_url}/checks)\n`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
